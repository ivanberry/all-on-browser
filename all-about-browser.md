## 面向前端的浏览器

> [浏览器所有](http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/)

通过对这边文字的学习,基本上可以理解浏览器了,对于前端工程师而言,对其中的底层知识,可先暂时搁置,其实是底层的知识我不懂,那我就装个X翻译翻译下这篇"大论",提取其中对我们前端而言重要的部分,或者说必须知道的部分。

### 能干吗?

在我们需要对浏览器深入了解时,先看看它能帮我们做什么?

它为们展现我们选择的资源,通常这些资源都是HTML,但不全是,也可以是PDF,image,甚至其他一些我不知道的类型的资源,这些能定位到这些资源的我们称为URI。

### 浏览器顶层结构

1. 用户接口

这些东西没有什么细说的价值,就是浏览器上,用户操作的一些按钮什么的,它们也没有什么标准规范,各种浏览器都有自己的UI。

2. 浏览引擎

UI和渲染引擎的中间层

3. 渲染引擎

负责展现我们请求数据内容

4. 网络

5. UI Backend

弹窗等

6. JavaScript解释器

分析和执行JavaScript代码

7. 储存

cookies, localStorage, IndexedDB, WebSQL 等等

![顶层结构](./images/highlevel.png)


这里需要重点提到的一点：Chrome会同时运行多个渲染引擎实例，每一个Tab就是一个独立的渲染引擎，这也是Chrome的一个核心技术，当然对于内存不够的机器来说，不但不能很好的享受这带来的好处，还会觉得：尼玛，老子开几个页面就卡成🐶啦！

### 渲染引擎

那么渲染引擎的作用是干啥的呢？....渲染（ヾ(｡｀Д´｡)）

渲染引擎的作用就是在浏览器或者说我们的屏幕上展现我们请求的资源，通常情况下就是HTML等，这里我们关注最主要的应用：展现与美美的CSS结合后的HTML

1. 渲染引擎

不同的浏览器使用了不同渲染引擎：IE用的Trident， Firefox用的是Gecko，Safari用的是Webkit，Chrome和Opera用的是Webkit的一个分支Blink。这真是，突出一个百家争鸣啊！

2. 主要流程

渲染引擎可能有多种，但是他们工作的主要流程大同小异的，看图说话：

![主要流程](./images/mainflow.png)

首先渲染引擎将分析HTMl文档并转化为DOM节点树，它成为“内容树”，接着把CSS和这个节点树结合起来就成了“渲染树”，渲染树是包含着可视的一些属性颜色和维度等的方块，这些方块都按着自己的顺序排排坐在屏幕上！

再来就是我们“布局”的过程了，这是个什么鬼呢？这个过程引擎会将各个方块准确无误的定位到它应该出现的坐标上，再接着就是“绘制”过程，这个过程聚会遍历所有的节点，并通过**UI backend**绘制出来。

**注意**：

我们这里必须非常明确一点细节，上述各个流程不是完全一步一步走完的，为了更好的用户体验，渲染引擎会尝试尽可能快的展现我们的画面，它不会等到所有的HMTL文档生产DOM树才渲染，布局和绘制。

![webkit 主要流程细节](./images/webkitflow.png)

![gecko主要流程细节](./images/geckoflow.jpg)

上述来看，它们细节上有点差别，但是总体上表现是一致的，我们就不深究其中的差异了。

### 词法拆分

原文中从比较底层的概念分析了，词法拆分的过程，我尝试在细读之后，口语化得说明吧！

拆分概念上就是讲我们的文档翻译成代码可以使用的文档结构，拆分的结果常是能反映文档结构的节点树，常称为语法树，举个拆分表达式2 + 3 - 1的例子：

![拆分实例](./images/parsing.png)

那么拆分是根据什么东西拆分的呢？它总不能按照它的心情来拆分吧，它当然是有依据：格式化文档依据的语法规则。任何文档形成必要都要遵从一定的词法和语法规则，称为**Context-free grammar**，简称**CFG**,人类自然语言没有对应的语法，所以不能被常用的拆分机制来拆分。

### 拆分

根据CFG规则的定义，我们很容易联想到可以将整个拆分过程分为：词法拆分和语法拆分。

词法拆分是指将输入文档拆分为**token**的过程，这里的token我不知道翻译成什么好？令牌？单词？还是不处理吧！token是指构成单元，在自然语言中，它就是指所有的各种单词。

语法拆分就是应用语法规则的过程，概念上很好理解的。

**Parse**常将拆分工作分为两步：

![拆分流程](./images/parse-flow.png)

图上，我们能清晰地看到它的流程，了解就好。











